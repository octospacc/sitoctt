+++
Title = "üåΩ Compilare e installare il kernel Linux da sorgente"
Date = 2024-09-01
Downsync = "/it/note/Compilare-Installare-Linux-Kernel.html"
Categories = [ "Linux" ]
+++

<!-- Autogenerated by ListedDownsync.js. Do not edit (unless also set "% Downsync = False") - it would be overwritten. -->

<p>Non di frequente mi saltano in mente nuove idee, ma, quando lo fanno, sono sempre bizzarre al punto giusto... Senza divagare troppo, √® proprio per questo svilupparsi delle cose che anni fa, per la prima volta, mi sono trovata a compilare da sorgente il kernel Linux ‚Äî su un Raspberry Pi 3 tra l'altro, cosa che col senno di poi non consiglierei ‚Äî e adesso, precisamente ieri, di nuovo un'altra volta dopo anni (stavolta sul PC, per fortuna), per un fine che non spoilero.</p>

<h2>Perch√© ricompilare il kernel?</h2>

<p>Linux si basa su un'architettura monolitica, cosa che ci riguarderebbe poco... se non fosse per il fatto che ha un'implicazione scomoda: qualsiasi funzione che lavora a livello di kernel deve essere compilata nello stesso. Anche il meccanismo dei cosidetti moduli non copre tutte le situazioni possibili (almeno non a livello pratici), e ci si pu√≤ quindi trovare in delle situazioni in cui il kernel fornito dalla distribuzione (o dal produttore hardware), anche se aggiornato, non ha qualcosa che serve, e quindi va sostituito.</p>



<p>Considerando le variet√† infinite di distribuzioni Linux, repository che distribuiscono kernel compatibili o meno, e unendo ci√≤ alla diversit√† di singole opzioni abilitabili nella compilazione del kernel... non solo in rari casi la compilazione da sorgente √® l'unica via, ma spesso e volentieri √® quella pi√π pratica. Per fortuna, compilare il kernel Linux √® molto semplice ‚Äî decisamente di pi√π dell'applicazione media per il desktop Linux, con tremila dipendenze sempre in conflitto ‚Äî ma ci sono dettagli magari non proprio immediati nel procedimento, quindi... ecco la mia nota!</p>

<h2>0. Partenza e prerequisiti</h2>

<p>Questa nota √® sulla pi√π generica ricompilazione del kernel Linux, cio√® la variante ufficiale (quella di Linus Torvalds) su e per un PC desktop x86_64 (o AMD64). Niente fork o varianti patchate, niente versioni di OEM scassacose, niente installazione su dispositivi embedded o in qualunque altra misura esoterici, niente compilazione distribuita o cross-platform. Per casi pi√π o meno limite, le cose da fare possono pi√π o meno variare, anche se l'andazzo rimane lo stesso... vedete voi dai, il punto √® che io assumo questa situazione. Nel mio caso, non ci sono nemmeno moduli kernel proprietari.</p>

<p>A parte eventuali strumenti preferiti per ottenere il kernel, nel caso scompattarlo, e qualche distrazione per passare il non poco tempo, i prerequisiti sono abbastanza ridotti. Come minimo serve un compilatore C (gcc) per motivi ovvi, GNU Make per eseguire i makefile, qualche tool assortito dal nome dimenticabile e qualche libreria super-specifica dall'interesse limitato. Poi, credo possano servire altri pacchetti, dipendentemente dalla distribuzione Linux in uso o dalle funzionalit√† che si devono compilare.</p>

<p>Non √® in realt√† chiarissimo sul web quali sono i pacchetti davvero necessari, e quali quelli che qualcuno che ha fatto altre guide ha detto "boh, mettiamo per sicurezza"... aggiorno qui con dei listini precisi man mano che verifico, includendo se necessario anche dei listoni eccessivi (per chi √® a posto con il perdere lo spazio ma non il tempo). Per me √® in genere una strategia installare il minimo possibile quando qualche requisito non √® chiaro, avviare la compilazione, ed installare le altre eventuali dipendenze man mano che escono errori a riguardo.</p>



<ul>
<li>Debian e derivate (<code class="prettyprint">apt</code>): <code class="prettyprint">build-essential libelf-dev</code> (obbligatori); <code class="prettyprint">ncurses-dev</code> (per usare la configurazione a menu TUI).</li>
</ul>

<h2>1. Ottenimento del codice</h2>

<p>Il codice sorgente di Linux si pu√≤ prendere ufficialmente <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git" rel="noopener nofollow" target="_blank">dal Git principale</a>, <a href="https://github.com/torvalds/linux" rel="noopener nofollow" target="_blank">dal GitHub di Torvalds</a>, o <a href="https://kernel.org" rel="noopener nofollow" target="_blank">dal sito Kernel.org</a>. Preferisco l'ultima opzione, che ha le ultime versioni effettivamente necessarie messe belle in vista, fino al pi√π vecchio branch supportato.</p>

<p>Di versioni supportate in un dato momento, appunto, ce ne sono diverse. In genere, se non c'√® motivo di installare un kernel vecchio, uno pi√π nuovo √® meglio; non troppo nuovo, per√≤, perch√© a vivere sul bleeding edge si perde sangue, con gli occasionali problemi anche gravi che possono saltare fuori! Quindi, evito il branch <code class="prettyprint">mainline</code>, aggiornato giornalmente o quasi, come la peste, e in genere scelgo <code class="prettyprint">stable</code>, aggiornato con un po' di giorni in pi√π. Altri utenti potrebbero legittimamente preferire la <code class="prettyprint">longterm</code> pi√π recente (quella pi√π in alto), per avere ancora pi√π stabilit√†, ma io lo trovo inutile.</p>

<p>Per la riga di ogni versione, a parte la data, quello che interessa √® il link [tarball], quindi si scarica quel file l√¨. Lo si pu√≤ poi estrarre in una cartella comoda, tra i tanti modi, con il comando <code class="prettyprint">tar xvf &lt;file&gt;</code>.</p>

<p>...Bisognerebbe scaricare poi anche il file pgp, quando presente, che serve a verificare che il download sia integro e che provenga dai distributori legittimi. Realisticamente, per√≤, gi√† non tutte le versioni lo hanno (stando a sottintendere che sotto sotto...), il download si fa dal sito ufficiale con HTTPS (quindi difficile sar√† alterato), √® un archivio compresso (quindi se corrotto dovrebbe fallire l'estrazione), e in tutto ci√≤ √® una rottura di scatole allucinante. Altri enti avranno requisiti di sicurezza pi√π alti, ma per gli utenti privati francamente √® solo noia, io non lo faccio, non mi freca.</p>



<h2>2. Configurazione del kernel</h2>

<p>Configurare il kernel √® la parte pi√π intricata... perch√© non si pu√≤ eseguire comandi per inerzia, ma bisogna <em>scegliere</em> quello che effettivamente serve per, beh, avere il kernel con le opzioni bone. Ci sono, come accennato, infinite configurazioni, e diversi modi di usarle. Il punto principale √® che c'√® un file di testo enorme, con varie opzioni (principalmente booleane), che si pu√≤ modificare.</p>

<p>Modificare quel coso a mano √® da pazzi, per√≤, perch√© esistono degli strumenti basati su menu ordinati, previsti nel processo di build, per gestire le varie possibilit√†. Anche qui, mezzo casino, ma la scelta √® principalmente tra due programmi rispettivamente TUI e GUI, invocabili rispettivamente con <code class="prettyprint">make menuconfig</code> e <code class="prettyprint">make xconfig</code>. Io preferisco <code class="prettyprint">xconfig</code> per comodit√† e, seppure ho usato in passato la configurazione a menu curses, ed √® per me abbastanza intuitiva, a quanto pare per molti non lo √®... e il come si usi quel menu non √® argomento di oggi.</p>

<table><thead>
<tr>
<th>menuconfig vs xconfig</th>
</tr>
</thead><tbody>
<tr>
<td><img src="{{< assetsRoot >}}/Media/Linux-Kernel/menuconfig.png" alt="menuconfig"></td>
</tr>
<tr>
<td>vs</td>
</tr>
<tr>
<td><img src="{{< assetsRoot >}}/Media/Linux-Kernel/xconfig.png" alt="xconfig"></td>
</tr>
</tbody></table>

<p>Se non si fa altro, la configurazione che si va a modificare √® quella predefinita del kernel come sta venendo sviluppato. Io non ho mai avuto problemi usando quella come base, ma, qualora ce ne fosse bisogno, oltre che quelle condivise da altri utenti, si pu√≤ usare quella della distribuzione corrente. In base a come il sistema espone la configurazione del kernel, la si pu√≤ (in genere) leggere con <code class="prettyprint">cat /boot/config-$(uname r)</code>, <code class="prettyprint">cat /boot/config</code>, o <code class="prettyprint">zcat /proc/config.gz</code>. Basta scriverla (<code class="prettyprint">&gt;</code>) sul file <code class="prettyprint">./.config</code> per applicarla alla configurazione corrente.</p>

<p>Io in questo caso volevo attivare il supporto al nuovo driver NTFS, quindi in xconfig premo CTRL+F, cerco "ntfs3" e imposto su (Y)es l'opzione che parla di "NTFS Read/Write <em>something something</em>"; poi, salvo la configurazione, chiudo, e... ho finito, incredibile.</p>

<h2>3. Compilazione del codice</h2>

<p>Con la compilazione, √® il momento della noia, perch√© bisogna dare al computer semplicemente il tempo di macinare milioni (!) di righe di codice. Bene non va, ma almeno non √® la fine del mondo: su qualunque PC non proprio scassone bisognerebbe farcela in meno di 4 ore. Sul Raspberry Pi 3 mi impieg√≤ una giornata e mezza con la CPU a temperature nucleari (e anche per questo lo sconsiglio...), ma sul mio PC (Ryzen 3 3200G, 16 GB di RAM di cui pochi occupati dalla compilazione, su un SSD di fascia bassa) mi pare di aver impiegato 3 ore scarse a compilare la versione 6.10.7.</p>

<p>Bisogna semplicemente eseguire <code class="prettyprint">make</code>, e Linuc si far√† da solo, viva la magia! Meglio ancora, <code class="prettyprint">make -j$(nproc)</code> per usare tutti i core CPU disponibili... La manciata di ore, dovrei precisare, √® misurata rispetto a questo, altrimenti sarebbe mezza giornata, dato che il mio PC ha 4 core; potrebbe fare molto prima avendo pi√π core, perch√© pu√≤ compilare ancora pi√π file in parallelo efficacemente.</p>

<p>Almeno nei primi minuti, √® bene tenere d'occhio il terminale, per vedere se si verifica qualche errore e la compilazione si arresta. A me errori assurdi non sono mai capitati, ma, come ho detto, se non si installano tutte le dipendenze, potrebbe uscire qualcosa di relativo a quelle... in tal caso, si installa quello che manca (facendo riferimento alla propria distribuzione), e si continua con il comando di prima.</p>

<p>Dipendentemente dalla configurazione, servir√† avere pi√π o meno spazio su disco per completare. Nel mio caso, alla fine della compilazione la cartella √® arrivata a pesare ~25 GB, quindi √® bene o assicurarsi di avere abbastanza spazio, oppure controllare di tanto in tanto che questo non stia finendo. E se finisce durante il processo, semplicemente si libera spazio e si continua, anche in questo caso, come prima. (A patto che non vi si corrompa il file system solo per l'essersi riempito al 100%, vero BTRFS?)</p>

<h2>4. Installazione di kernel e moduli</h2>

<p>Per compilare il kernel non sono necessari permessi di root, il che √® comodo nel caso si voglia temporaneamente rubare il computer pi√π potente di qualcun altro per fare il lavoro... ma, per installare, quelli ovviamente servono sul sistema corrente.</p>

<p>Qui √® non solo semplice, ma anche abbastanza veloce (massimo qualche minuto): eseguendo (come root) prima <code class="prettyprint">make install</code>, e poi <code class="prettyprint">INSTALL_MOD_STRIP=1 make install_modules</code>, verranno installati nei percorsi appropriati, rispettivamente (ammesso di non aver cambiato i nomi): l'immagine kernel (<code class="prettyprint">vmlinuz-x.x.x-...</code>), di solito in <code class="prettyprint">/boot</code> e i moduli, di solito in <code class="prettyprint">/lib/modules/linux-x.x.x-...</code>. I moduli sono file separati dal kernel, perch√© vengono caricati dal sistema quando necessario... il punto √® che alcuni tra i tanti servono a completare il boot, quindi vanno installati.</p>

<p>Bisogna anche preparare il cosiddetto file system di init, o ramdisk iniziale; normalmente finisce anch'esso in <code class="prettyprint">/boot</code>, sotto il nome di <code class="prettyprint">initrd.img-x.x.x-...</code>. E questo passaggio sarebbe abbastanza scomodo se non esistesse <code class="prettyprint">kernel-install</code>, script incluso con systemd, o la sua alternativa <code class="prettyprint">installkernel</code>. Avendo systemd, almeno il primo dovrebbe gi√† essere installato, e in quel caso (assumendo i nomi di prima) basta fare (come root) <code class="prettyprint">kernel-install add x.x.x-... /boot/vmlinuz-x.x.x-...</code>; alternativamente, con il secondo, <code class="prettyprint">installkernel x.x.x-... /boot/vmlinuz-x.x.x-...</code>.</p>

<p>Nota: chi sviluppa col kernel (non chi sta leggendo questo post, temo) potrebbe voler non settare la variabile d'ambiente <code class="prettyprint">INSTALL_MOD_STRIP=1</code>, perch√© debuggare senza i simboli di debug, che quella flag toglie, √® difficile... ma per utenti comuni mortali come me sprecano solo spazio (tant'√® che le distribuzioni li pacchettizzano a parte). Inoltre, chi non necessariamente sviluppa col kernel, ma deve compilare moduli esterni o fare altri magheggi, dovrebbe realisticamente anche installare i file header corrispondenti sul sistema: <code class="prettyprint">make headers_install</code> (sempre come root).</p>

<p>Almeno su distribuzioni "complete", <code class="prettyprint">make install</code> e poi <code class="prettyprint">kernel-install</code> dovrebbero aver gi√† configurato anche il bootloader, almeno avendo GRUB. Nel caso di distribuzioni, per cos√¨ dire, "pi√π fai-da-te" (che io non uso, <em>btw</em>), cos√¨ come configurazioni di avvio pi√π insolite... non √® il caso mio, quindi non so nulla, e non dir√≤ nulla. Le configurazioni di avvio sono una bestia per un'altra volta.</p>

<h2>5. Prova del nocciolo</h2>

<p>Se il kernel √® installato, e il bootloader √® stato correttamente configurato, allora basta semplicemente riavviare il computer per godere. √à bene ricordare che, nel caso si stia usando GRUB, certi dicono che il nuovo kernel non viene selezionato come predefinito, e bisogna sceglierlo a mano dal menu di avvio... ma nel mio caso, su Linux Mint Debian Edition, mi √® sembrato che invece fosse stato proprio impostato come default.</p>

<p>Ancora, se, ringraziando il pinguinone, il sistema alla fine parte, basta usare il comando <code class="prettyprint">uname -r</code> per controllare la versione del kernel in esecuzione. A questo punto, √® bene verificare che la configurazione <em>desiderata</em> stia effettivamente funzionando... ma il come fare ci√≤ cambia da funzionalit√† a funzionalit√†, caso per caso. Per confermare quantomeno che la configurazione <em>specificata</em> ci sia, basta controllare la configurazione del kernel corrente come al punto 2.</p>

<p>A questo punto, nel caso funzioni tutto e non servano altre modifiche, si pu√≤ anche cancellare l'enorme cartella di compilazione, e il kernel rimarr√†. Nel caso si dovesse in futuro anche disinstallare il kernel, basta cancellare normalmente i file installati prima, e riconfigurare il bootloader in modo appropriato.</p>

<h2>Conclusione</h2>

<p>Poter compilare il kernel dal codice sorgente √® un'altra di quelle cose che noi utenti Linux possiamo fare, e che gli utenti Windows francamente <strong>non</strong> ci invidiano. Ma √® perch√© a loro piace vincere facile, col loro NT, basato su un design a microkernel... proprio cos√¨, ora che il punto dell'articolo √® finito posso dire scemenze a ruota come piace a me.</p>

<p>Copium a parte, compilare Linux pu√≤ essere qualcosa di divertente da fare almeno una volta. Se si capita in situazioni scomode come me va fatto, c'√® poco da fare; per√≤, se volete semplicemente divertirvi in modo stupido, magari una delle tante cose da poter fare √® compilare un kernel ultra-specifico e super-ottimizzato per la propria macchina, o per una macchina virtuale. E certo, consuma un po' di energia, ma mai quanto minare criptovalute o renderizzare missili nucleari in Blender!</p>



<h2>{{% i18n notes-refs %}}</h2>

<ul>
<li>A Guide to Compiling the Linux Kernel All By Yourself: <a href="https://itsfoss.com/compile-linux-kernel/" rel="noopener nofollow" target="_blank">https://itsfoss.com/compile-linux-kernel/</a></li>
<li>Building and Installing Custom Linux Kernels (Rocky Linux): <a href="https://docs.rockylinux.org/guides/custom-linux-kernel/" rel="noopener nofollow" target="_blank">https://docs.rockylinux.org/guides/custom-linux-kernel/</a></li>
<li>Installkernel/kernel-install (Gentoo Linux): <a href="https://wiki.gentoo.org/wiki/Installkernel" rel="noopener nofollow" target="_blank">https://wiki.gentoo.org/wiki/Installkernel</a></li>
</ul>
